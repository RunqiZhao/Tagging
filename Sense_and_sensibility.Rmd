---
title: "Sense_and_sensibility"
author: "Runqi Zhao, Haoran Su"
date: "2020/11/19"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: cerulean
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  
                      warning = FALSE,
                      message = FALSE)
library(tnum)
library(httr)
library(tidyverse)
library(magrittr)
library(dplyr)
library(ggplot2)
library(tidytext)
library(janeaustenr)
library(stringr)
library(tidyr)
```

```{r include=FALSE}
addChapt <- function(data,name){
  data$Chapter <- as.numeric(substring(separate(data, subject, c("Auther_Book","Chapter", "Paragraph","Sentence"),sep = "/")$Chapter, 9))
  names(data)[names(data) == "Chapter"] <- name
  return(data)
}
```


# Query from Sense and sensibility

```{r}
# Get authorize
tnum.authorize(ip="54.158.136.133")
```

```{r include=FALSE}
# tnum.getDatabasePhraseList("subject", levels=3, max=30000)
```

*Get all sentences including "marry" or "marriage" and "engage"*

```{r}
marry <- tnum.query("*sense* has * = REGEXP(\"marry|marriage\")", max=200)
textdf1<-tnum.objectsToDf(marry)
```

```{r}
Engage <- tnum.query("*sense* has * = REGEXP(\"engage\")", max = 200)
# Returned 1 thru 124 of 124 results
EngageDf <- tnum.objectsToDf(Engage)
# View(EngageDf)
```
*Tagging each sentences with reference*
```{r}
# tnum.tagByQuery("*sense* has * = REGEXP(\"engage\")", adds=("reference:engage_from_Sense"))
# list(modifiedCount = 124, tagged = 124, removed = 0)

# tnum.tagByQuery("*sense* has text = REGEXP(\"marry|marriage\")", "reference:marry_from_Sense")

```
*Get the text back with tags*
```{r}
Engage2 <- tnum.query("@reference:engage_from_Sense", max = 200)
# Returned 1 thru 124 of 124 results
EngageDf2 <- tnum.objectsToDf(Engage2)
# View(EngageDf2)
# head(EngageDf2)

num2 <- tnum.query("@reference:marry_from_Sense", max = 200)
textdf2<-tnum.objectsToDf(num2)
```

# Plot of wordby chapters

## Path graph
*Take engage as example*
```{r}
graEngage <- tnum.makePhraseGraphFromPathList(tnum.getAttrFromList(Engage2, "subject"))
tnum.plotGraph(graEngage)
```

## Sentiment analysis

```{r include=FALSE}
tidy_books <- austen_books() %>%
  group_by(book) %>%
  mutate(
    linenumber = row_number(),
    chapter = cumsum(str_detect(text, 
                                regex("^chapter [\\divxlc]", 
                                      ignore_case = TRUE)))) %>%
  ungroup() %>%
  unnest_tokens(word, text)
```

```{r}
tidy_books <- tidy_books %>%  filter(book == "Sense & Sensibility") 

jane_austen_sentiment <- tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
  count(book, index = chapter, sentiment) %>%
  spread(sentiment, n, fill = 0) %>%
  mutate(sentiment = positive - negative)

ggplot(jane_austen_sentiment, aes(index, sentiment)) +
  geom_col(show.legend = FALSE, fill = "lightblue", width = 0.8 ) +
  labs(x = "Chapter", y = "Score", title = "Sentiment") +
  geom_smooth(se = F)
```


## Word Engage

```{r}
# Add chapter
EngagePlot <- addChapt(EngageDf2,"Chapter")

# Bar chart by chapter
EngagePlot2 <- EngagePlot %>% group_by(Chapter) %>% summarize(count = n())

ggplot(data = EngagePlot2,aes(x = Chapter, y = count)) + 
  geom_bar(width = 0.8, fill="cadetblue3",stat="identity") + 
  labs(x = "Chapter", y = "Number of Engage Appeared in the chapter", title = "Appearance of Engage in each Chapter") + 
  geom_smooth(se = F)
```

From this bar chart, we can find that Engage occurs more frequently during the middle part of this book, and get an increase at the end of the book. It's reasonable that at the start of the book, under the pressure of life, Mr Henry's death, looking for a new home, the sisters has less time for their love stories.  
After settled down, they have more time for social, meet and fall in love with their heroes and the stories turn to the secret engagement of Willoughby and the Edward's ordered engagement. So the words come up.  
And associate with the sentiment plot above, the engagement plots are coming with the pain of heroines, so the sentiment socres for these chapters are pretty low. 


## Words Marry/Marriage

```{r}
# Add chapter
counting <- addChapt(textdf1,"chapter_n")

# Bar chart by chapter
counting <- counting %>% group_by(chapter_n) %>% summarize(count = n())

ggplot(counting, aes(x = chapter_n, y = count)) +
  geom_bar(stat = "identity", fill = "cadetblue3") +
  geom_smooth(se=F)+
  labs(x = "Chapter", y = "Number of Marry/Marriage Appeared in the chapter", title = "Appearance of Marry/Marriage in each Chapter")
```

From the barchart, we can see that "marry/marriage" appear more often in the chapter 6,14,15,17,30-33,37-40,48-50.  
The counting of the word "marry/marriage" is increasingly larger in the last few chapters as the main characters are paving into the marriage.  
The first upper flow of the line appears around chapter 30 while the first upper flow of the line for "engage" appears around chapter 20.  
It indicates the topic "engagement" mentions often before the topic "marriage".  
The appearance of the word "marriage" increases with the emotional development to the two extreme sides(showed by the chapters where the sentiment socres for are pretty low or high), When the characters get in love or get depart, the words about love, marriage, engage would appear more.


